<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Images Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="css/site.css">
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <link rel="manifest" href="images/site.webmanifest">
    <link rel="icon" href="favicon.ico">
</head>

<body>

    <div class="mainContainer">
        <div class="headerPanel">
            <div class="headerLayout">
                <img src="images/camera.png" alt="" data-toggle="tooltip" class="favicon" onclick="aPropos()"
                    style="cursor: pointer;">
                <div style="display:flex">
                    <span class="header outLinedText tbg-yellow">
                        P
                    </span>
                    <span class="header outLinedText tbg-orange">
                        I
                    </span>
                    <span class="header outLinedText tbg-red">
                        C
                    </span>
                    <span class="header outLinedText tbg-pink ">
                        T
                    </span>
                    <span class="header outLinedText tbg-black">
                        -
                    </span>
                    <span class="header outLinedText tbg-purple">
                        C
                    </span>
                    <span class="header outLinedText tbg-blue">
                        L
                    </span>
                    <span class="header outLinedText tbg-green">
                        O
                    </span>
                    <span class="header outLinedText tbg-grass">
                        U
                    </span>
                    <span class="header outLinedText tbg-yellow">
                        D
                    </span>
                </div>


            </div>
            <span class="cmd fa fa-arrow-up-wide-short" id="triDateAscDesc" title="Trier ascendant"
                data-toggle="tooltip" onclick="changeTriDate()"></span>
            <span class="cmd fa-solid fa-magnifying-glass-plus" id="searchBy" title="Rechercher par filtre"
                data-toggle="tooltip" onclick="showHideResearchBar()"></span>


            <div id="userViewConnected">
                <span id="userNameConnected"></span>
                <span class="cmd fa fa-plus-square" id="newImageCmd" title="Ajouter une image"
                    data-toggle="tooltip"></span>
                <div id="userIdentification">
                    <img src="images/No_Avatar.png" alt="Image de l'utilisateur" id="imageUser">
                    <span id="userName" style="font-weight: bold; font-size: 18px;" onclick="showVerificationDlg()"></span>
                    <span class="cmd fa fa-user-gear" id="modifyUserCmd" title="Modifier votre compte" onclick="modifyUser()"
                        data-toggle="tooltip"></span>
                </div>
                <span class="cmd fa fa-right-from-bracket" id="logoutCmd" title="Se déconnecter" onclick="disconnect()"
                    data-toggle="tooltip"></span>

            </div>

            <div id="userViewNotConnected">
                <span class="cmd fa fa-right-to-bracket" id="loginCmd" title="Se connecter"
                    data-toggle="tooltip"></span>
                <span class="cmd fa fa-user-plus" id="createAccountCmd" title="Créer un compte"
                    data-toggle="tooltip"></span>
            </div>


        </div>
        <div id="researchDiv">
            <div class="researchBarLayout">
                <label for="searchByUser">Recherche par utilisateur:</label>
                <select id="searchByUser" class="form-control">
                </select>
                <label for="research">Recherche par mot(s) ou caractère(s):</label>
                <input type="search" id="research" class="form-control" placeholder="Recherche par caractères" />
                <span class="cmd fa-solid fa-magnifying-glass" id="searchBtn" title="Lancer la recherche"></span>
            </div>
        </div>
        <div class="scrollContainer">
            <div id="imagesList">
                <!-- filled programmatically-->
            </div>
        </div>
        <div>
            <div id="imageDlg">
                <form id="imageForm">
                    <input type="hidden" id="Id_input" value="0">
                    <input type="hidden" id="date_input" value="0">
                    <input type="hidden" id="GUID_input" value="">
                    <input type="hidden" id="userId_input" value="0">

                    <label for="title_input">Titre</label>
                    <input type="text" id="title_input" class="form-control" required>

                    <label for="decription_input">Description</label>
                    <textarea id="description_input" class="form-control" required></textarea>

                    <label for="image">Image</label>
                    <div id='image' class='ImageUploader' defaultImage='images/No_Image.png'
                        waitingImage='images/writing.gif'>
                    </div>
                    <label for="shared_checkbox">Partagé l'image</label>
                    <input type="checkbox" name="shared_checkbox" id="shared_checkbox">
                    <div class="note">Cliquez-Déposez une image</div>
                </form>
            </div>
            <div id="loginDlg">
                <form id="loginForm">
                    <label for="loginEmail_input">Courriel</label>
                    <input type="text" id="loginEmail_input" class="form-control" required>

                    <label for="loginPassword_input">Mot de passe</label>
                    <input type="password" id="loginPassword_input" class="form-control" required>

                    <input type="checkbox" id="remember_me" onclick="changeRememberState()">
                    <label for="remember_me">Se souvenir de moi</label>
                </form>
            </div>
            <div id="accountDlg">
                <form id="accountForm">
                    <input type="hidden" id="userId_input" value="0">
                    <input type="hidden" id="userGUID_input" value="">

                    <label for="userName_input">Nom d'usager</label>
                    <input type="text" id="userName_input" class="form-control" required>

                    <label for="userEmail_input">Courriel</label>
                    <input type="text" id="userEmail_input" class="form-control" required>

                    <label for="userPassword_input">Mot de passe</label>
                    <input type="password" id="userPassword_input" class="form-control" required>

                    <label for="userConfirmation_input">Confirmation</label>
                    <input type="password" id="userConfirmation_input" class="form-control" required>

                    <label for="avatar">Avatar</label>
                    <div id='avatar' class='ImageUploader' defaultImage='images/No_Avatar.png'
                        waitingImage='images/writing.gif'>
                    </div>
                </form>
            </div>
            <div id="verifyAccountDlg">
                <form id="verifyForm">
                    <p>Consultez votre boîte de courriel pour connaître votre code de vérification et inscrivez-le
                        ci-dessous.</p>
                    <label for="verify_input">Code de vérification</label>
                    <input type="text" id="verify_input" class="form-control" required>
                </form>
            </div>

            <div id="aProposDlg">
                <h5 id="nom">Développeur: Vincent Lepage</h5>
            </div>
            <div id="confirmDeleteDlg">
                <span id="confirmationMessage"></span>
            </div>
            <div id="errorDlg">
                <span id="errorMessage"></span>
            </div>
            <div id="imageInfoDlg">
                <a href="" id="imageInfoHref"><img src="" alt="Une image" id="imageInfoImg"></a>
                <label for="imageInfoTitre">Titre:</label>
                <div id="imageInfoTitre" style="font-weight: bold;"></div>
                <label for="imageInfoDescription">Description:</label>
                <p id="imageInfoDescription">
                </p>
                <label for="imageInfoUserName">Auteur:</label>
                <img src="" alt="user avatar" id="imageInfoUserAvatar"><span id="imageInfoUserName"></span><br>
                <label for="imageInfoDate">Date de publication:</label>
                <div id="imageInfoDate"></div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.maskedinput/1.4.1/jquery.maskedinput.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="js/customValidation.js"></script>
    <script src="js/imageUploader.js"></script>
    <script src="js/api.js"></script>
    <script src="js/userApi.js"></script>
    <script src="js/date.js"></script>
    <script defer>
        const periodicRefreshPeriod = 15;
        let holdCheckETag = false;
        let currentETag = "";
        let createMode = true;
        let hideSearchBar = true;
        let IdToDelete = 0; // used by confirmDeleteDlg
        let selectedUserId = 0;
        let imagesCount = 50;
        let appendCount = 3;
        let previousScrollPosition = 0;
        let appendMode = false;
        let userConnected = false;
        let loginInfo = [];
        let userLoginEntry = [];
        let remember = false;
        let descending = true;
        let passwordConfirmation = "";
        let noVerifyAccount = [];
        let showResearchBar = false;
        let connectedAccount = [];
        let imageOrAccountToDelete = "";
        let imagesList = [];
        let userIdToDelete = 0;

        init_UI();
        HEAD(checkETag, error);
        setInterval(() => { HEAD(checkETag, error) }, periodicRefreshPeriod * 1000);
        checkIfConnectedUser();

        function aPropos() {
            $("#aProposDlg").dialog('open');
        }

        function showVerificationDlg()
        {
            if (!isVerifiedUser())
                mailVerification(connectedAccount);
        }

        function changeRememberState() {
            if (localStorage.getItem("remember") == 1) {
                localStorage.setItem("remember", 0);
            }
            else {
                localStorage.setItem("remember", 1);
            }
        }

        function checkIfConnectedUser() {
            if (sessionStorage.getItem("userId") > 0) {
                let login = {
                    Email: localStorage.getItem("email"),
                    Password: localStorage.getItem("mdp"),
                    WantRemember: wantRemember()
                };
                USER_LOGIN(login, UserConnected, null);
            }
        }

        function mailVerification(account) {
            connectedAccount = account;
            getUser();
            $("#verifyAccountDlg").dialog('option', 'title', "Vérification de courriel");
            $("#verifyAccountOkBtn").text('Vérifier');
            $("#verifyAccountDlg").dialog('open');
        }

        function showHideResearchBar() {
            showResearchBar = !showResearchBar;
            if (showResearchBar) {
                $("#researchDiv").show();
                document.getElementById("searchBy").className = "cmd fa-solid fa-magnifying-glass-minus";
            }
            else {
                $("#researchDiv").hide();
                document.getElementById("searchBy").className = "cmd fa-solid fa-magnifying-glass-plus";
                selectedUserId = 0;
                $("#research").val("");
                getImagesList();

            }
        }

        function changeTriDate() {
            descending = !descending;
            if (descending) {
                document.getElementById("triDateAscDesc").className = `cmd fa fa-arrow-up-wide-short`;
                document.getElementById("triDateAscDesc").title = 'Trier ascendant';
            }
            else {
                document.getElementById("triDateAscDesc").className = `cmd fa fa-arrow-down-wide-short`;
                document.getElementById("triDateAscDesc").title = 'Trier descendant';
            }

            getImagesList();
        }

        function checkETag(ETag) {
            if (!holdCheckETag && ETag != currentETag) {
                currentETag = ETag;
                getImagesList();
            }
        }

        function getImagesList(refresh = true) {
            appendMode = !refresh;
            function prepareQueryString() {
                let queryString = "";
                let searchByCharacter = $("#research").val();
                if (appendMode) {
                    queryString = `?sort=Date,${descending ? "desc" : "asc"}&offset=${Math.trunc(imagesCount / appendCount)}&limit=${appendCount}&UserId=${selectedUserId != 0 ? selectedUserId : "*"}`;
                    imagesCount += appendCount;
                } else {
                    queryString = `?sort=Date,${descending ? "desc" : "asc"}&offset=${0}&limit=${imagesCount}&UserId=${selectedUserId != 0 ? selectedUserId : "*"}`;
                }
                if (searchByCharacter != "")
                    queryString += `&Title=*${searchByCharacter}*&Description=*${searchByCharacter}*`;
                return queryString;
            }
            GET_ALL(refreshimagesList, error, prepareQueryString());
            GET_ALL(refreshUserList, error, "?fields=UserId,Username");
        }

        function refreshUserList(users) {
            $("#searchByUser").empty();
            $("#searchByUser").append("<option value=''>Tous les utilisateurs</option>");
            id = parseInt(selectedUserId);
            for (let item of users) {
                let selected = (id == item.UserId ? " selected " : "");
                if (loginInfo.UserId == item.UserId) {
                    $("#searchByUser").append(`<option value='${item.UserId}' ${selected}>Mes images</option>`);
                }
                else {
                    $("#searchByUser").append(`<option value='${item.UserId}' ${selected}>${item.Username}</option>`);
                }
            }
        }
        function refreshimagesList(images, ETag) {
            function insertIntoImageList(image) {

                if (image.UserId == loginInfo.UserId) {
                    $("#imagesList").append(
                        $(` 
                                <div class='imageLayout'>
                                    <div class='imageHeader'>
                                        <div class="imageTitle">${image.Title}</div>
                                        <div    class="cmd editCmd  fa fa-pencil-square" 
                                                imageid="${image.Id}" 
                                                title="Editer ${image.Title}" 
                                                data-toggle="tooltip">
                                        </div>
                                        <div    class="cmd deleteCmd fa fa-window-close" 
                                                imageid="${image.Id}" 
                                                title="Effacer ${image.Title}" 
                                                data-toggle="tooltip">
                                        </div>
                                    </div> 
                                        <div class='image' onclick="afficherInfoImage(${image.Id})"
                                                style="background-image:url('${image.ThumbnailURL}')">
                                                <img src="${image.UserAvatarURL == "" ? "images/No_Avatar.png" : image.UserAvatarURL}" alt="UserAvatar" class="imageAvatar" title="${image.Username}">`
                                                + (image.Shared ? '<img src="images/shared.png" alt="UserAvatar" class="imageAvatar" title="Partagé">' : '') + `
                                        </div>
                                    <div class="imageDate">${convertToFrenchDate(parseInt(image.Date))}</div>
                                </div>
                        `)
                    );
                }
                else {
                    if (image.Shared)
                    {
                        $("#imagesList").append(
                        $(` 
                                <div class='imageLayout' onclick="afficherInfoImage(${image.Id})">
                                    <div class='imageHeader'>
                                        <div class="imageTitle">${image.Title}</div>
                                    </div>
                                        <div class='image' onclick="afficherInfoImage(${image.Id})"
                                                style="background-image:url('${image.ThumbnailURL}')">
                                                <img src="${image.UserAvatarURL}" alt="UserAvatar" class="imageAvatar" title="${image.Username}">
                                        </div>
                                    <div class="imageDate">${convertToFrenchDate(parseInt(image.Date))}</div>
                                </div>
                        `)
                        );
                    }
                    
                }
            }
            currentETag = ETag;
            previousScrollPosition = $(".scrollContainer").scrollTop();
            if (!appendMode) $("#imagesList").empty();

            if (appendMode && images.length == 0)
                imagesCount -= appendCount;

            for (let image of images) {
                insertIntoImageList(image);
            }

            $(".scrollContainer").scrollTop(previousScrollPosition);
            $(".editCmd").off();
            $(".deleteCmd").off();
            $(".showMore").off();
            $(".editCmd").click(e => { editimage(e) });
            $(".deleteCmd").click(e => { deleteimage(e) });

            $('[data-toggle="tooltip"]').tooltip();
        }

        function afficherInfoImage(imageid) {
            GET_ID(imageid, setImagePage, error);
        }

        function setImagePage(image) {
            resetImagePage();

            document.getElementById("imageInfoTitre").innerHTML = image.Title;
            document.getElementById("imageInfoDescription").innerHTML = image.Description;
            document.getElementById("imageInfoImg").src = image.OriginalURL;
            document.getElementById("imageInfoHref").href = image.OriginalURL;
            document.getElementById("imageInfoUserAvatar").src = image.UserAvatarURL;
            document.getElementById("imageInfoUserName").innerHTML = image.Username;
            document.getElementById("imageInfoDate").innerHTML = convertToFrenchDate(parseInt(image.Date));

            configDialog();

            function configDialog() {
                holdCheckETag = true;
                $("#imageInfoDlg").dialog('option', 'title', "Informations de l'image");
                $("#imageInfoDlg").dialog('open');
            }
            function resetImagePage() {
                document.getElementById("imageInfoTitre").innerHTML = "";
                document.getElementById("imageInfoDescription").innerHTML = "";
                document.getElementById("imageInfoImg").src = "";
                document.getElementById("imageInfoHref").href = "";
                document.getElementById("imageInfoUserAvatar").src = "";
                document.getElementById("imageInfoUserName").innerHTML = "";
                document.getElementById("imageInfoDate").innerHTML = "";
            }
        }

        function error(status) {
            let errorMessage = "";
            switch (status) {
                case 0:
                    errorMessage = "Le service ne répond pas";
                    break;
                case 401:
                    errorMessage = "Requête non autorisée";
                    break;
                case 400:
                case 422:
                    errorMessage = "Requête invalide";
                    break;
                case 404:
                    errorMessage = "Service ou données introuvables";
                    break;
                case 409:
                    errorMessage = "Conflits de données: Hyperlien existe déjà";
                    break;
                case 500:
                    errorMessage = "Erreur interne du service";
                    break;
                default:
                    errorMessage = "Une erreur est survenue";
                    break;
            }
            $("#errorMessage").text(errorMessage);
            $("#errorDlg").dialog('open');
        }

        function newImage() {
            holdCheckETag = true;
            createMode = true;
            resetimageForm();
            ImageUploader.imageRequired('image', true);
            $("#imageDlg").dialog('option', 'title', "Ajout d'image");
            $("#imageDlgOkBtn").text("Ajouter");
            $("#imageDlg").dialog('open');
        }
        function editimage(e) {
            holdCheckETag = true;
            createMode = false;
            GET_ID(e.target.getAttribute("imageid"), imageToForm, error);
            holdCheckETag = true;
            ImageUploader.imageRequired('image', false);
            $("#imageDlg").dialog('option', 'title', "Modification d'image");
            $("#imageDlgOkBtn").text("Modifier");
            $("#imageDlg").dialog('open');
        }
        function deleteimage(e) {
            holdCheckETag = true;
            imageOrAccountToDelete = "image";
            IdToDelete = e.target.getAttribute("imageid")
            GET_ID(
                IdToDelete,
                image => {
                    $("#confirmationMessage").html("Voulez-vous vraiment effacer l'image <br><b>" + image.Title + "</b>?")
                },
                error
            );
            holdCheckETag = true;
            $("#confirmDlg").dialog('option', 'title', "Retrait d'image'...");
            $("#confirmDeleteDlgOkBtn").text("Effacer");
            $("#confirmDeleteDlg").dialog('open');
        }
        function resetimageForm() {
            $("#Id_input").val("0");
            $("#GUID_input").val("");
            $("#date_input").val(Date.now());
            $("#title_input").val("");
            $("#description_input").val("");
            $("#userId_input").val("0");
            document.getElementById("shared_checkbox").checked = false;
            ImageUploader.resetImage('image');
        }
        function imageFromForm() {
            if ($("#imageForm")[0].checkValidity()) {
                let image = {
                    Id: parseInt($("#Id_input").val()),
                    GUID: $("#GUID_input").val(),
                    Title: $("#title_input").val(),
                    Description: $("#description_input").val(),
                    ImageData: ImageUploader.getImageData('image'),
                    Date: parseInt($("#date_input").val()),
                    UserId: loginInfo.UserId,
                    Shared: document.getElementById("shared_checkbox").checked
                };
                return image;
            } else {
                $("#imageForm")[0].reportValidity()
            }
            return false;
        }
        function imageToForm(image) {
            $("#Id_input").val(image.Id);
            $("#GUID_input").val(image.GUID);
            $("#date_input").val(image.Date);
            //$("#date_input").val(Date.now());
            $("#title_input").val(image.Title);
            $("#description_input").val(image.Description);
            $("#userId_input").val(image.UserId);
            document.getElementById("shared_checkbox").checked = image.Shared;
            ImageUploader.setImage('image', image.OriginalURL);
        }

        function wantRemember() {
            return document.getElementById("remember_me").checked;
        }

        function loginFromForm() {
            if ($("#loginForm")[0].checkValidity()) {
                let login = {
                    Email: $("#loginEmail_input").val(),
                    Password: $("#loginPassword_input").val(),
                    WantRemember: wantRemember()
                };
                return login;
            } else {
                $("#loginForm")[0].reportValidity()
            }
            return false;
        }

        function resetLoginForm() {
            $("#loginEmail_input").val("");
            $("#loginPassword_input").val("");
            document.getElementById("remember_me").checked = false;
        }

        function disconnect() {
            USER_LOGOUT(loginInfo.UserId, disconnectionComplete, error)
        }

        function disconnectionComplete() {
            sessionStorage.clear();
            location.reload(true);
        }
        function getUser() {
            if (connectedAccount.length != 0)
                USER_GET(connectedAccount.Id, saveUser, error)
            else
                USER_GET(loginInfo.UserId, saveUser, error)
        }

        function saveUser(user) {
            sessionStorage.setItem("userId", user.Id);
            if (user.AvatarGUID != "") {
                if (user.AvatarGUID != undefined) {
                    let avatar = user.AvatarURL;
                    let supp = "http://localhost:5000/images/";
                    avatar = avatar.substr(supp.length);
                    document.getElementById("imageUser").src = "../images/" + avatar;
                }
            }
            connectedAccount = user;
            if (isVerifiedUser()) {
                document.getElementById("userIdentification").style.color = 'blue';
            }
            else {
                document.getElementById("userIdentification").style.color = 'red';
            }
        }

        function UserConnected(login) {
            loginInfo = login;
            getUser()
            sessionStorage.setItem("access_token", loginInfo.Access_token);
            if (localStorage.getItem("remember")) {
                remember = true;
            }
            else {
                remember = false;
            }
            document.getElementById("userViewConnected").style.display = "inline";
            document.getElementById("userViewNotConnected").style.display = "none";
            $("#userName").html(`${loginInfo.Username}`);

            getImagesList();
        }

        function isVerifiedUser() {
            return connectedAccount.VerifyCode == "verified";
        }

        function loginUser() {
            holdCheckETag = true;

            if (localStorage.getItem("remember") == 1) {
                document.getElementById("remember_me").checked = true;
                $("#loginEmail_input").val(localStorage.getItem("email"));
                $("#loginPassword_input").val(localStorage.getItem("mdp"));
            }
            else {
                document.getElementById("remember_me").checked = false;
            }
            $("#loginDlg").dialog('option', 'title', "Connexion");
            $("#loginDlgOkBtn").text('Connexion');
            $("#loginDlg").dialog('open');
        }

        function createAccount() {
            holdCheckETag = true;
            createMode = true;
            ImageUploader.imageRequired('avatar', false);
            $("#accountDlgDeleteAccountBtn").hide();
            $("#accountDlg").dialog('option', 'title', "Création de compte");
            $("#accountDlgOkBtn").text('Créer');
            $("#accountDlg").dialog('open');
        }

        function modifyUser() {
            holdCheckETag = true;
            createMode = false;
            USER_GET(connectedAccount.Id, accountToForm, error);
            ImageUploader.imageRequired('avatar', false);
            $("#accountDlgDeleteAccountBtn").show();
            $("#accountDlg").dialog('option', 'title', "Modification de compte");
            $("#accountDlgOkBtn").text('Modifier');
            $("#accountDlg").dialog('open'); 
        }

        function deleteAccount(){
            holdCheckETag = true;
            imageOrAccountToDelete = "account";
            IdToDelete = connectedAccount.Id;
            USER_GET(
                IdToDelete,
                account => {
                    $("#confirmationMessage").html("Voulez-vous vraiment supprimer votre compte <br><b>" + account.Name + "</b>?")
                },
                error
            );
            holdCheckETag = true;
            $("#confirmDlg").dialog('option', 'title', "Supression du compte");
            $("#confirmDeleteDlgOkBtn").text("Supprimer");
            $("#confirmDeleteDlg").dialog('open');
        }

        function getAllImagesForDelete()
        {
            GET_ALL(deleteImgOfDeleteUser, error);
            disconnect();
            localStorage.clear();
        }

        function deleteImgOfDeleteUser(imagesList) {
            let count = 0;
            imagesList.forEach(image => {
                if (image.UserId == userIdToDelete)
                {
                    count++;
                    DELETE(image.Id, () => console.log(count + " image(s) supprimée(s)."), error);
                }
            });
            userIdToDelete = 0;
        }


        function resetAccountForm() {
            parseInt($("#userId_input").val(0)),
                $("#userName_input").val(""),
                $("#userEmail_input").val(""),
                $("#userPassword_input").val(""),
                $("#userGUID_input").val("");
                ImageUploader.resetImage('avatar');
        }
        function accountFromForm() {
            if ($("#accountForm")[0].checkValidity()) {
                let account = {
                    Id: parseInt($("#userId_input").val()),
                    Name: $("#userName_input").val(),
                    Email: $("#userEmail_input").val(),
                    Password: $("#userPassword_input").val(),
                    AvatarGUID: $("#userGUID_input").val(),
                    ImageData: ImageUploader.getImageData('avatar'),
                };
                passwordConfirmation = $("#userConfirmation_input").val();
                return account;
            } else {
                $("#accountForm")[0].reportValidity()
            }
            return false;
        }

        function transformAvatarURLToGUID(avatarURL) {
            if (avatarURL != "http://localhost:5000/images/undefined.png") {
                let supp = "http://localhost:5000/images/";
                let avatarGUID = avatarURL.substr(supp.length);
                return avatarGUID;
            }
            return "";
        }

        function accountToForm(account) {
            $("#userId_input").val(account.Id);
            $("#userName_input").val(account.Name);
            $("#userEmail_input").val(account.Email);
            document.getElementById("userPassword_input").required = false;
            document.getElementById("userConfirmation_input").required = false;
            if (account.AvatarGUID == undefined || account.AvatarGUID == "")
                ImageUploader.setImage('avatar', "images/No_Avatar.png");
            else
                ImageUploader.setImage('avatar', account.AvatarURL);
            $("#userGUID_input").val(account.AvatarGUID);
        }

        function connectUser() {
            USER_GET(connectedAccount.Id, firstLoginAfterVerification, error);
        }

        function firstLoginAfterVerification(user) {
            let login = {
                Email: user.Email,
                Password: localStorage.getItem("mdp")
            }
            USER_LOGIN(login, UserConnected, error);
        }

        function init_UI() {
            $("#searchByUser").change(() => { selectedUserId = $("#searchByUser").val(); getImagesList(); })
            $("#newImageCmd").click(newImage);
            $("#searchBtn").click(getImagesList)
            $("#createAccountCmd").click(createAccount);
            $("#loginCmd").click(loginUser);
            $("#loginDlg").dialog({
                title: "...",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 640,
                minWidth: 640,
                maxWidth: 640,
                height: 380,
                minHeight: 380,
                maxHeight: 380,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    id: "loginDlgOkBtn",
                    text: "Connexion",
                    click: function () {
                        holdCheckETag = false;
                        let login = loginFromForm();
                        if (login) {
                            userLoginEntry = login;
                            if (userLoginEntry.WantRemember) {
                                localStorage.setItem("remember", 1);
                                localStorage.setItem("email", userLoginEntry.Email);
                                localStorage.setItem("mdp", userLoginEntry.Password);
                            }
                            else {
                                localStorage.setItem("remember", 0);
                            }
                            USER_LOGIN(login, UserConnected, error);
                        }

                        $(this).dialog("close");
                    }
                },
                {
                    text: "Annuler",
                    click: function () {
                        holdCheckETag = false;
                        $(this).dialog("close");
                    }
                }]
            });

            $("#imageInfoDlg").dialog({
                title: "...",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 1200,
                minWidth: 1200,
                maxWidth: 1200,
                height: 750,
                minHeight: 750,
                maxHeight: 750,
                position: { my: "top", at: "top", of: window },
                buttons: [
                    {
                        text: "Fermer",
                        click: function () {
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }]
            });

            $("#verifyAccountDlg").dialog({
                title: "...",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 440,
                minWidth: 440,
                maxWidth: 440,
                height: 390,
                minHeight: 390,
                maxHeight: 390,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    id: "verifyAccountOkBtn",
                    text: "Vérifier",
                    click: function () {
                        let code = $("#verify_input").val();
                        USER_GET_VERIFICATION_CODE(connectedAccount.Id, parseInt(code), connectUser, error);
                        holdCheckETag = false;
                        $(this).dialog("close");
                    }
                },
                {
                    text: "Annuler",
                    click: function () {
                        holdCheckETag = false;
                        $(this).dialog("close");
                    }
                }]
            });

            $("#accountDlg").dialog({
                title: "...",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 640,
                minWidth: 640,
                maxWidth: 640,
                height: 800,
                minHeight: 800,
                maxHeight: 800,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    id: "accountDlgDeleteAccountBtn",
                    text: "Désinscrire",
                    click: function () {
                        holdCheckETag = false;
                        deleteAccount();
                        $(this).dialog("close");
                    }
                },
                {
                    id: "accountDlgOkBtn",
                    text: "...",
                    click: function () {
                        let account = accountFromForm();
                        if (account) {
                            if (createMode) {
                                if (account.Password == passwordConfirmation) {
                                    USER_POST(account, mailVerification, error, "register");
                                    holdCheckETag = false;
                                    $(this).dialog("close");
                                }
                                else
                                    alert("Les mots de passe ne correspondent pas.")
                            }
                            else {
                                if (document.getElementById("userPassword_input").value != "")
                                    document.getElementById("userConfirmation_input").required = true;
                                else {
                                    document.getElementById("userConfirmation_input").required = false;
                                }

                                if (document.getElementById("userPassword_input").value == document.getElementById("userConfirmation_input").value) {
                                    if (account.Password == "") {
                                        account.Password = localStorage.getItem("mdp");
                                    }
                                    if (account.Email == connectedAccount.Email) {
                                        USER_MODIFY(account, getUser, error);
                                        resetAccountForm();
                                    }
                                    else {
                                        USER_MODIFY(account, mailVerification, error);
                                        resetAccountForm();
                                    }
                                    holdCheckETag = false;
                                    $(this).dialog("close");
                                }
                                else {
                                    alert("Les mots de passe ne correspondent pas.");
                                }
                            }
                            getImagesList();
                        }
                    }
                },
                {
                    text: "Annuler",
                    click: function () {
                        holdCheckETag = false;
                        $(this).dialog("close");
                    }
                }
                ]
            })


            $("#imageDlg").dialog({
                title: "...",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 640,
                minWidth: 640,
                maxWidth: 640,
                height: 780,
                minHeight: 780,
                maxHeight: 780,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    id: "imageDlgOkBtn",
                    text: "Title will be changed dynamically",
                    click: function () {
                        let image = imageFromForm();
                        if (image) {
                            if (createMode) {
                                POST(image, getImagesList, error);
                                $(".scrollContainer").scrollTop(0);
                            }
                            else
                                PUT(image, getImagesList, error);
                            resetimageForm();
                            holdCheckETag = false;
                            $(this).dialog("close");
                        }
                    }
                },
                {
                    text: "Annuler",
                    click: function () {
                        holdCheckETag = false;
                        $(this).dialog("close");
                    }
                }]
            });

            $("#confirmDeleteDlg").dialog({
                title: "Attention!",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 500, minWidth: 500, maxWidth: 500,
                height: 230, minHeight: 230, maxHeight: 230,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    id: "confirmDeleteDlgOkBtn",
                    text: "Oui",
                    click: function () {
                        holdCheckETag = false;
                        if (IdToDelete)
                            if (imageOrAccountToDelete == "image")
                                DELETE(IdToDelete, getImagesList, error);
                            else if (imageOrAccountToDelete == "account")
                            {
                                userIdToDelete = IdToDelete;
                                USER_DELETE(IdToDelete, getAllImagesForDelete, error, loginInfo.Access_token);

                            }
                            IdToDelete = 0;
                            imageOrAccountToDelete = "";
                        $(this).dialog("close");
                    }
                },
                {
                    text: "Annuler",
                    click: function () {
                        holdCheckETag = false;
                        IdToDelete = 0;
                        $(this).dialog("close");
                    }
                }]
            });

            $("#aProposDlg").dialog({
                title: "À propos",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 500, minWidth: 500, maxWidth: 500,
                height: 200, minHeight: 200, maxHeight: 200,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    text: "Fermer",
                    click: function () {
                        holdCheckETag = false;
                        $(this).dialog("close");
                    }
                }]
            });

            $("#errorDlg").dialog({
                title: "Erreur...",
                autoOpen: false,
                modal: true,
                show: { effect: 'fade', speed: 400 },
                hide: { effect: 'fade', speed: 400 },
                width: 500, minWidth: 500, maxWidth: 500,
                height: 230, minHeight: 230, maxHeight: 230,
                position: { my: "top", at: "top", of: window },
                buttons: [{
                    text: "Fermer",
                    click: function () {
                        holdCheckETag = false;
                        IdToDelete = 0;
                        $(this).dialog("close");
                    }
                }]
            });

            $(".scrollContainer").scroll(function () {
                if ($(".scrollContainer").scrollTop() + $(".scrollContainer").innerHeight() >= $("#imagesList").height()) {
                    getImagesList(false);
                }
            });
        }
    </script>

</body>

</html>